普段趣味でOS開発をしているのですが、フルスクラッチ & Pure Rust & aarch64向けというなかなかニッチなプロジェクトな為エラーに出くわしてもなかなか解決法が見つからない事がよくあります
そんな孤独と戦っているであろう同胞たちが居ると信じて、最近自分が大いに悩まされたケースの紹介とどうやって解決したかの解説をします

この記事が役立つかも知れない人

- bootloaderから自作している人
- aarch64向けのOSを書いてる人
- 開発にqemuを利用している人
- rustでOSを作っている人

- カーネルが呼び出せない
  - x86_64向けビルドでは動作する
- 原因の洗い出し
  - exit_boot_servicesが失敗した？
  - カーネルのアドレスが間違ってる？
    - elfのパースが間違ってる？
  - 例外が発生した？
  - boot service終了後にboot serviceを呼び出している？
- デバッグ
  - printデバッグ
  - mnemonicデバッグ（バイナリブレークポイント）
    - qemuコンソールでのコマンド
      - `info registers`
      - `x /10i 0xXXXXXXX`
  - `wfi`と`wfe`
    - panic_handlerには`wfi`、バイナリブレークポイントには`wfe`というような使い分けをした
- 解決
  - UEFIはMMUを有効化する
  - uefiが管理するメモリ領域においてはidentity mappedである
  - そのほかの領域については実装によって異なる
  - つまりx86_64向けビルドではMMUがtity mappedだった
  - MMUを無効化すると良い
